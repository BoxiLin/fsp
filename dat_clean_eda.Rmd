---
title: "Fredericton square parking"
author: "Boxi Lin"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(lubridate)
library(zoo)
```

## 0. Objective

The City of Fredericton operates a parking garage that can be accessed on a pay-as-you-go (hourly) basis or using monthly/daily parking permits.  The City wants to ensure there is always some space available for hourly parking to support downtown businesses while keeping the garage as full as possible with monthly permit holders to ensure efficient use; i.e., if too many parking permits are sold, then there will not be enough spaces for pay-as-you-go users.  In order to find the optimal number of permits sold, students will have access to a dataset generated by automated cameras operated by Hotspot Parking.  These have recorded a large sample of the license plates of cars using the parking garage over a 6+ month period, which can be cross-referenced with a database of permit holders and hence used to model the permit holder demand for parking spaces as a function of the time of day.

- Did the FSP utilize the parking spots?
- Should they sell more monthly parking permit?
- Exploring the data: 
    - data quality;
    - seasonal patterns;
    - structures and meaning of data columns

## 1. Information provided by organizor  

- 513 parking spot in total;
- Each parking lot zone has two cameras (entrance and exit, known, maybe inferred by the time differences)

## 2. Exploratory data analysis

```{r, include = FALSE}
dat_camera <- data.table::fread("Frederick_Square_Parking_Garage_Camera_Plate_Detection.csv") %>% 
  mutate(camera_time_stamp = as.POSIXct(camera_time_stamp,format="%d-%m-%Y %H:%M:%S",tz="America/Moncton"),
         weekday <- wday(camera_time_stamp),
         camera_date = ymd(as.Date(camera_time_stamp)))
dat_change <- data.table::fread("Frederick_Square_Parking_Occupancy_Change_Detection.csv")  %>% 
  mutate(timestamp = as.POSIXct(timestamp,format="%d-%m-%Y %H:%M:%S",tz="America/Moncton"),
         change_year_month = format(as.Date(timestamp), "%Y-%m"))
dat_holder <- data.table::fread("Frederick_Square_Permit_Holder.csv") %>%
  mutate(issued_date = as.POSIXct(issued_date,format="%d-%m-%Y",tz="America/Moncton"),
         expiry_date = as.POSIXct(expiry_date,format="%d-%m-%Y",tz="America/Moncton"),
         issued_year_month =  format(as.Date(issued_date), "%Y-%m"))
# head(dat_camera)
# head(dat_change)
# head(dat_holder)
```


-  Three camera: ID: 390919685,  597150892, 2140086156
   -  Missing one?
-  Camera time stamp range: 2020-07-16 ~ 2021-06-30
-  Plate change date range: 2020-11-04 ~ 2021-07-20 
-  Permit issue/expiry date range: 2020-11 ~ 2021-08


```{r, echo = FALSE, fig.width=10, fig.height=5}
dt = data.frame(table(dat_holder$issued_year_month))
barplot(dt$Freq~dt$Var1, main = "Monthly permit sale volume",
        xlab = "Month", ylab = "Number of monthly permit sold")
```

-  Monthly permit sale volume by Lot zone

  | Permit ID | Lot zone ID | Count |
  |:---------:|:-----------:|:-----:|
  | 199       | 9           | 282   |
  | 348       | 101         | 909   |
  | 357       | 99          | 108   |
  | 358       | 100         | 148   |
  
  
```{r, fig.width=10, fig.height=3, echo=FALSE}
dt = data.frame(table(dat_camera$camera_date))
dat_camera_permit = dplyr::filter(dat_camera, plate_hashed %in% dat_holder$licence_plate_hash)
dt_permit = data.frame(table(dat_camera_permit$camera_date))
inds <- seq(as.Date("2020-07-16"), as.Date("2021-06-30"), by = "day")
plot(zoo(dt$Freq,inds), ylab = "", xlab = "Time", main = "Daily camera record counts" )
lines(zoo(dt_permit$Freq, inds), col = "red")
legend("top", legend = c("All", "Permit owner (underestimated)"), col = c("black", "red"), lty = 1, bg = "transparent", bty = "n")
```


```{r, eval=FALSE}
dat_camera$permit <- 0
dat_camera$permit_change <- 0
sum(dat_camera$plate_hashed %in% dat_holder$licence_plate_hash) # 39,268
sum(dat_camera$plate_hashed %in% dat_change$old_licence_plate_hash) # 13,302
pb = txtProgressBar(min = 0, max = dim(dat_camera)[1], style = 3) 
for (i in 1:dim(dat_camera)[1]) {
  camera_date = format(dat_camera$camera_date[i],"%Y-%m")
  holder_date <- dplyr::filter(dat_holder, issued_year_month==camera_date)$licence_plate_hash
  change_date <- dplyr::filter(dat_change, change_year_month==camera_date)$old_licence_plate_hash
  dat_camera$permit[i] <- (dat_camera$plate_hashed[i] %in% holder_date)
  dat_camera$permit_change[i] <- (dat_camera$plate_hashed[i] %in% change_date)
  setTxtProgressBar(pb,i)
}
dat_camera$permit_user <- (dat_camera$permit | dat_camera$permit_change)
dat_camera$permit_user[dat_camera$camera_date < as.Date("2020-11-01")] <- (-999)

saveRDS(dat_camera, file = "dat_camera.rds")
saveRDS(dat_holder, file = "dat_holder.rds")
saveRDS(dat_change, file = "dat_change.rds")
```


